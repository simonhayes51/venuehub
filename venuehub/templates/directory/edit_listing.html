{% extends "base.html" %}
{% block title %}Edit â€” {{ listing.title }}{% endblock %}
{% block content %}
<h2 class="mb-2">Edit listing</h2>
<p class="text-muted">Share this private manage link only with your team.</p>
<div class="alert alert-secondary small">
  Manage link: <code>{{ request.build_absolute_uri }}?code={{ listing.edit_code }}</code>
</div>

<div class="row g-4">
  <div class="col-lg-7">
    <form method="post" enctype="multipart/form-data">{% csrf_token %}
      <input type="hidden" name="code" value="{{ listing.edit_code }}">
      {{ form.as_p }}
      <button class="btn btn-primary" name="save_listing">Save changes</button>
      {% if listing.is_premium %}<span class="badge bg-warning text-dark ms-2">Premium active</span>{% endif %}
    </form>

    <hr class="my-4">

    <h5>Gallery</h5>
    <form method="post" enctype="multipart/form-data" class="mb-3">{% csrf_token %}
      <input type="hidden" name="code" value="{{ listing.edit_code }}">
      {{ img_form.as_p }}
      <button class="btn btn-outline-primary" name="add_image">Add image</button>
    </form>
    <div class="row row-cols-2 row-cols-md-3 g-3">
      {% for g in listing.images.all %}
        <div class="col">
          <div class="card h-100">
            <img src="{{ g.image.url }}" class="card-img-top" alt="{{ g.caption|default:'Image' }}">
            {% if g.caption %}<div class="card-body py-2"><div class="small">{{ g.caption }}</div></div>{% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No gallery images yet.</p>
      {% endfor %}
    </div>
  </div>

  <div class="col-lg-5">
    <div class="border rounded p-3 bg-light">
      <h5 class="mb-2">Premium</h5>
      {% if not listing.is_premium %}
        <a class="btn btn-warning w-100" href="{% url 'billing:subscribe_index' %}?listing={{ listing.pk }}">Go Premium</a>
      {% else %}
        <p class="mb-2">Premium is active. {% if listing.featured_until %}<br><small class="text-muted">Featured until {{ listing.featured_until|date:"j M Y" }}</small>{% endif %}</p>
        {% if listing.stripe_customer_id %}
          <a class="btn btn-outline-primary w-100" href="{% url 'billing:portal' %}?listing={{ listing.pk }}">Open Billing Portal</a>
        {% endif %}
      {% endif %}
    </div>
    <div class="border rounded p-3 mt-3">
      <h6>Public profile</h6>
      <a class="btn btn-outline-secondary w-100" href="{% url 'directory:listing_detail' listing.pk %}">View public page</a>
    </div>
  </div>
</div>
{% endblock %}
